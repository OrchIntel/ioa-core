# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2025 OrchIntel Systems Ltd.
# https://orchintel.com | https://ioa.systems
#
# Part of IOA Core (Open Source Edition). See LICENSE at repo root.

groups:
- name: ioa.critical
  rules:
  # Critical Circuit Breaker Alerts
  - alert: IOACircuitBreakerOpen
    expr: ioa_circuit_breaker_state{service="s3"} == 1
    for: 1m
    labels:
      severity: critical
      service: s3
    annotations:
      description: "S3 circuit breaker has been open for {{ $value }} seconds. S3 operations are failing."
      runbook_url: "https://docs.ioa.com/runbooks/s3-circuit-breaker"
      
  - alert: IOACircuitBreakerOpen
    expr: ioa_circuit_breaker_state{service="kms"} == 1
    for: 1m
    labels:
      severity: critical
      service: kms
    annotations:
      description: "KMS circuit breaker has been open for {{ $value }} seconds. Signing operations are failing."
      runbook_url: "https://docs.ioa.com/runbooks/kms-circuit-breaker"
      
  # Critical Encryption Alerts
  - alert: IOAEncryptionErrors
    expr: rate(ioa_encryption_errors_total[1m]) > 1
    for: 1m
    labels:
      severity: critical
    annotations:
      description: "Encryption error rate is {{ $value }} errors/sec. Audit manifests may be unencrypted."
      runbook_url: "https://docs.ioa.com/runbooks/encryption-errors"
      
  # Critical Service Down
  - alert: IOAServiceDown
    expr: up{job=~"ioa-.*"} == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      description: "IOA service {{ $labels.job }} has been down for more than 2 minutes."
      runbook_url: "https://docs.ioa.com/runbooks/service-down"

- name: ioa.warning
  rules:
  # Authentication Alerts
  - alert: IOAAuthFailuresHigh
    expr: rate(ioa_auth_failures_total[5m]) > 5
    for: 2m
    labels:
      severity: warning
    annotations:
      description: "Authentication failure rate is {{ $value }} failures/sec. Check auth configuration."
      runbook_url: "https://docs.ioa.com/runbooks/auth-failures"
      
  # Backpressure Alerts
  - alert: IOABackpressureHigh
    expr: rate(ioa_backpressure_events_total[5m]) > 10
    for: 2m
    labels:
      severity: warning
    annotations:
      description: "Backpressure event rate is {{ $value }} events/sec. System may be overloaded."
      runbook_url: "https://docs.ioa.com/runbooks/backpressure"
      
  # KMS Alerts
  - alert: IOAKMSFailuresHigh
    expr: rate(ioa_kms_failures_total[5m]) > 3
    for: 2m
    labels:
      severity: warning
    annotations:
      description: "KMS failure rate is {{ $value }} failures/sec. Check KMS connectivity and permissions."
      runbook_url: "https://docs.ioa.com/runbooks/kms-failures"
      
  # S3 Alerts
  - alert: IOAS3FailuresHigh
    expr: rate(ioa_s3_failures_total[5m]) > 5
    for: 2m
    labels:
      severity: warning
    annotations:
      description: "S3 failure rate is {{ $value }} failures/sec. Check S3 connectivity and permissions."
      runbook_url: "https://docs.ioa.com/runbooks/s3-failures"
      
  # Performance Alerts
  - alert: IOAAuditQPSHigh
    expr: rate(ioa_audit_events_total[1m]) > 1000
    for: 1m
    labels:
      severity: warning
    annotations:
      description: "Audit QPS is {{ $value }} events/sec. Consider scaling or load balancing."
      runbook_url: "https://docs.ioa.com/runbooks/high-qps"
      
  - alert: IOAPendingBatchHigh
    expr: ioa_pending_batch_size > 500
    for: 1m
    labels:
      severity: warning
    annotations:
      description: "Pending batch size is {{ $value }} events. Audit processing may be delayed."
      runbook_url: "https://docs.ioa.com/runbooks/pending-batch"
      
  # Latency Alerts
  - alert: IOALatencyHigh
    expr: histogram_quantile(0.95, rate(ioa_audit_latency_seconds_bucket[5m])) > 5
    for: 3m
    labels:
      severity: warning
    annotations:
      description: "95th percentile latency is {{ $value }} seconds. Performance may be degraded."
      runbook_url: "https://docs.ioa.com/runbooks/high-latency"
      
  # Memory Alerts
  - alert: IOAMemoryHigh
    expr: ioa_memory_usage_bytes > 1073741824  # 1GB
    for: 5m
    labels:
      severity: warning
    annotations:
      description: "Memory usage is {{ $value }} bytes. Consider scaling or investigating memory leaks."
      runbook_url: "https://docs.ioa.com/runbooks/high-memory"
      
  # CPU Alerts
  - alert: IOACPUHigh
    expr: ioa_cpu_usage_percent > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      description: "CPU usage is {{ $value }}%. Consider scaling or optimizing performance."
      runbook_url: "https://docs.ioa.com/runbooks/high-cpu"

- name: ioa.info
  rules:
  # Info Alerts
  - alert: IOACircuitBreakerHalfOpen
    expr: ioa_circuit_breaker_state{service="s3"} == 2
    for: 0m
    labels:
      severity: info
    annotations:
      description: "S3 circuit breaker is testing recovery. Monitoring for success/failure."
      
  - alert: IOACircuitBreakerHalfOpen
    expr: ioa_circuit_breaker_state{service="kms"} == 2
    for: 0m
    labels:
      severity: info
    annotations:
      description: "KMS circuit breaker is testing recovery. Monitoring for success/failure."
      
  - alert: IOAHighThroughput
    expr: rate(ioa_audit_events_total[5m]) > 500
    for: 0m
    labels:
      severity: info
    annotations:
      description: "Audit QPS is {{ $value }} events/sec. System is handling high load."
